chrome.runtime.onInstalled.addListener(()=>{chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(()=>{})});chrome.runtime.onMessage.addListener((message,_sender,sendResponse)=>{if(message?.type==="EXECUTE_ACTION")return(async()=>{try{const e=message.action;if(e?.type==="navigate"){const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!r?.id)throw new Error("No active tab");await chrome.tabs.update(r.id,{url:e.url}),await new Promise(a=>{const s=(o,i)=>{o===r.id&&i.status==="complete"&&(chrome.tabs.onUpdated.removeListener(s),a())};chrome.tabs.onUpdated.addListener(s),setTimeout(()=>{chrome.tabs.onUpdated.removeListener(s),a()},15e3)}),sendResponse({ok:!0,result:{navigated:e.url}});return}const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t?.id)throw new Error("No active tab");const n=await chrome.tabs.sendMessage(t.id,message);sendResponse(n)}catch(e){sendResponse({ok:!1,error:String(e)})}})(),!0;if(message?.type==="EXECUTE_IN_PAGE_WORLD")return(async()=>{try{const[tab]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!tab?.id)throw new Error("No active tab");const results=await chrome.scripting.executeScript({target:{tabId:tab.id},world:"MAIN",func:(fnStr,args)=>{const fn=eval("("+fnStr+")");return fn(args)},args:[message.fn,message.args]}),result=results?.[0]?.result;sendResponse({ok:!0,result})}catch(e){sendResponse({ok:!1,error:String(e)})}})(),!0;if(message?.type==="GET_PAGE_CONTEXT")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id)throw new Error("No active tab");const t=await chrome.tabs.sendMessage(e.id,{type:"GET_PAGE_CONTEXT"});sendResponse(t)}catch(e){sendResponse({ok:!1,error:String(e)})}})(),!0});
