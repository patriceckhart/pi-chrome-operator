(function(){chrome.runtime.onMessage.addListener((e,t,r)=>{if(e?.type==="EXECUTE_ACTION")return d(e.action).then(o=>r({ok:!0,result:o})).catch(o=>r({ok:!1,error:String(o)})),!0;if(e?.type==="GET_PAGE_CONTEXT"){const o=i();return r({ok:!0,context:o}),!0}});function i(){const e=Array.from(document.querySelectorAll("input:not([type=hidden]), textarea, select")).slice(0,50).map((n,u)=>({selector:s(n),type:n.tagName==="SELECT"?"select":n.type||"text",name:n.name||"",placeholder:n.placeholder||"",value:n.value||""})),t=Array.from(document.querySelectorAll("button, [role=button], input[type=submit], input[type=button], a.btn, a.button")).slice(0,30).map((n,u)=>({selector:s(n),text:n.innerText?.trim().slice(0,80)||n.getAttribute("aria-label")||""})),r=Array.from(document.querySelectorAll("a[href]")).slice(0,40).map(n=>({text:n.innerText?.trim().slice(0,60)||"",href:n.href})).filter(n=>n.text),o=document.body?.innerText?.slice(0,8e3)||"";return{url:location.href,title:document.title,text:o,links:r,inputs:e,buttons:t}}function s(e,t,r){if(e.id)return`#${CSS.escape(e.id)}`;const o=e.getAttribute("data-testid");if(o)return`[data-testid="${CSS.escape(o)}"]`;const n=e.getAttribute("name");if(n){const l=`${e.tagName.toLowerCase()}[name="${CSS.escape(n)}"]`;if(document.querySelectorAll(l).length===1)return l}const u=e.getAttribute("aria-label");if(u){const l=`[aria-label="${CSS.escape(u)}"]`;if(document.querySelectorAll(l).length===1)return l}return a(e)}function a(e){const t=[];let r=e;for(;r&&r!==document.body&&t.length<5;){let o=r.tagName.toLowerCase();if(r.id){t.unshift(`#${CSS.escape(r.id)}`);break}const n=r.parentElement;if(n){const u=Array.from(n.children).filter(l=>l.tagName===r.tagName);if(u.length>1){const l=u.indexOf(r)+1;o+=`:nth-of-type(${l})`}}t.unshift(o),r=n}return t.join(" > ")}async function d(e){switch(e.type){case"navigate":return location.href=e.url,{navigated:e.url};case"click":{let t=null;if(e.selector&&(t=document.querySelector(e.selector)),!t&&e.text&&(t=f(e.text)),!t)throw new Error(`Element not found: ${e.selector||e.text}`);return t.scrollIntoView({behavior:"smooth",block:"center"}),await c(300),t.click(),{clicked:e.selector||e.text}}case"type":{const t=document.querySelector(e.selector);if(!t)throw new Error(`Input not found: ${e.selector}`);t.scrollIntoView({behavior:"smooth",block:"center"}),t.focus(),t.value="",t.dispatchEvent(new Event("input",{bubbles:!0}));for(const r of e.text)t.value+=r,t.dispatchEvent(new Event("input",{bubbles:!0})),await c(20+Math.random()*30);if(t.dispatchEvent(new Event("change",{bubbles:!0})),e.submit){await c(200);const r=t.closest("form");r?r.requestSubmit():t.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",bubbles:!0}))}return{typed:e.selector,text:e.text}}case"select":{const t=document.querySelector(e.selector);if(!t)throw new Error(`Select not found: ${e.selector}`);return t.value=e.value,t.dispatchEvent(new Event("change",{bubbles:!0})),{selected:e.value}}case"wait":return await c(e.ms),{waited:e.ms};case"scroll":{const t=e.amount??400;return window.scrollBy({top:e.direction==="down"?t:-t,behavior:"smooth"}),await c(500),{scrolled:e.direction}}case"extract":return e.selector?Array.from(document.querySelectorAll(e.selector)).map(r=>r.innerText?.trim()).filter(Boolean):document.body?.innerText?.slice(0,1e4);case"screenshot":return i();default:return{noop:!0}}}function f(e){const t=e.toLowerCase();return[...Array.from(document.querySelectorAll("button, a, [role=button]")),...Array.from(document.querySelectorAll("li, span, div, h1, h2, h3, h4, h5, h6, p"))].find(o=>o.innerText?.trim().toLowerCase().includes(t))??null}function c(e){return new Promise(t=>setTimeout(t,e))}
})()
